<!--
used to control the main flow of parsing

Copyright (C) 2011  Wen Qi <qiwen@qiwen.name>

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
  <script>
    var nextStartNum = 0;
    var likeNum = 0;
    var started = false;
    var parseStart = 0;

    var musics = new Array();

    function resetDate(startOrNot) {
      nextStartNum = 0;
      likeNum = 0;
      parseStart = 0;
      started = startOrNot;
    }

    function addMore(startFrom, mArr) {
      var len = musics.length;
      for (var i = 0; i < mArr.length; ++i) {
        musics[len + i] = mArr[i];
      }
      
      nextStartNum = startFrom + mArr.length;
      
      if (nextStartNum >= likeNum) {
        nextStartNum = -1;
      }
    }
    
    function isDoubanMusicLikeHome(url) {
      var pattern = /^http:\/\/douban\.fm\/mine\?&type=liked(.*)$/;
      if (url.match(pattern)) {
        return true;
      }
      return false;
    }

    function showNotification(t, b) {
      if (webkitNotifications.checkPermission() > 0) {
        webkitNotifications.requestPermission();
      }
      var notification = webkitNotifications.createNotification('douban.png', t, b);
      notification.show();
    }

    function startParse(tab) {
    	chrome.browserAction.setPopup({
        tabId: tab.id,       // Set the new popup for this tab. 
        popup: 'main.html'   // Open this html file within the popup. 
    	});
    }

    function pageLoaded(tab) {
      if (started) {
        var pattern = /^http:\/\/douban\.fm\/mine\?((start=[0-9]+&)*)type=liked(.*)$/;
        if (tab.url.match(pattern) && nextStartNum >= 0) {
          var parseStartStr = tab.url.match(/[0-9]+/);
          if (parseStartStr && parseStartStr.length > 0) {
            parseStart = new Number(parseStartStr[0]);
          }
          chrome.tabs.executeScript(tab.id, {file:'douban.js'});
        }
      }
    }

    function messageListener(port) {
      var tab = port.sender.tab;
      port.onMessage.addListener(function(info) {
        if (likeNum == 0) { // init Like number
          var numStr = info.totalLike.match(/[0-9]+/);
          if (numStr && numStr.length > 0) {
            likeNum = new Number(numStr[0]);
          }
          if (numStr == null || numStr.length == 0 || likeNum == 0) {
            	//showNotification("Error", info.totalLike + " 您好像没有登录豆瓣电台呀... :(");
            	//chrome.tabs.create({"url":"http://www.douban.com/accounts/login?source=radio&uid=&error=requiredemail"});
          }
        }
        //showNotification(parseStart + " " + likeNum, "");//info.selection);
        parseHtml(tab, info.selection);
      });
    }

    function getElementsByClass(searchClass, domNode, tagName) { 
      if (domNode == null) domNode = document;
      if (tagName == null) tagName = '*';
      var el = new Array();
      var tags = domNode.getElementsByTagName(tagName);
      var tcl = " "+searchClass+" ";
      for(i=0,j=0; i<tags.length; i++) { 
	var test = " " + tags[i].className + " ";
	if (test.indexOf(tcl) != -1) 
	  el[j++] = tags[i];
      }
      return el;
    }

    function parseHtml(tab, s) { // it's callback of background parser script
      var div = document.createElement('div');
      var pageMusics = new Array();
      div.innerHTML = s;
      
      var tr = getElementsByClass("info_wrapper", div);
    
      if (tr) {
        for (var i = 0; i < tr.length; ++i) {
          var td = tr[i];
          var m = new Array();
	  var musicName = getElementsByClass("song_title", td);
	  var source = td.getElementsByTagName('a');
	  var performer = getElementsByClass("performer", td);
	  var action = getElementsByClass('action', td);
          m[0] = musicName[0].innerText; //歌曲名
          m[1] = source[1].href;      //专辑URL
          m[2] = source[1].innerText; //专辑名
          m[3] = performer[0].innerText; //歌手名
          m[4] = action[0].sid; //Music ID
          pageMusics[i] = m;
        }
      }
      
      addMore(parseStart, pageMusics);

      if (nextStartNum >= 0) {
        chrome.tabs.remove(tab.id, function(){
          chrome.tabs.create({"url":"http://douban.fm/mine?start=" + nextStartNum +"&type=liked"});
        });
      } else {
        resetDate(false);
        chrome.tabs.remove(tab.id, function(){
          	chrome.tabs.create({"url":"options.html"});
        });
      }
    }

    chrome.browserAction.onClicked.addListener(startParse);
    chrome.extension.onConnect.addListener(messageListener);
    chrome.tabs.onCreated.addListener(pageLoaded);
  </script>
</html>