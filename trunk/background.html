<html>
  <script>
    var nextStartNum = 0;
    var likeNum = 0;
    var started = false;
    var parseStart = 0;

    var musics = new Array();

		function resetDate(startOrNot) {
			nextStartNum = 0;
	    likeNum = 0;
	    parseStart = 0;
	    started = startOrNot;
		}

    function addMore(startFrom, mArr) {
      var len = musics.length;
      for (var i = 0; i < mArr.length; ++i) {
        musics[len + i] = mArr[i];
      }
      
      nextStartNum = startFrom + mArr.length;
      
      if (nextStartNum >= likeNum) {
        nextStartNum = -1;
      }
    }
    
    function isDoubanMusicLikeHome(url) {
      var pattern = /^http:\/\/douban\.fm\/mine\?&type=liked(.*)$/;
      if (url.match(pattern)) {
        return true;
      }
      return false;
    }

    function showNotification(t, b) {
      if (webkitNotifications.checkPermission() > 0) {
        webkitNotifications.requestPermission();
      }
      var notification = webkitNotifications.createNotification('douban.png', t, b);
      notification.show();
    }

    function startParse(tab) {
    	chrome.browserAction.setPopup({
        tabId: tab.id,       // Set the new popup for this tab. 
        popup: 'main.html'   // Open this html file within the popup. 
    	});
    }

    function pageLoaded(tab) {
      if (started) {
        var pattern = /^http:\/\/douban\.fm\/mine\?((start=[0-9]+&)*)type=liked(.*)$/;
        if (tab.url.match(pattern) && nextStartNum >= 0) {
          var parseStartStr = tab.url.match(/[0-9]+/);
          if (parseStartStr && parseStartStr.length > 0) {
            parseStart = new Number(parseStartStr[0]);
          }
          chrome.tabs.executeScript(tab.id, {file:'douban.js'});
        }
      }
    }

    function messageListener(port) {
      var tab = port.sender.tab;
      port.onMessage.addListener(function(info) {
        if (likeNum == 0) { // init Like number
          var numStr = info.totalLike.match(/[0-9]+/);
          if (numStr && numStr.length > 0) {
            likeNum = new Number(numStr[0]);
          }
          if (numStr == null || numStr.length == 0 || likeNum == 0) {
            	showNotification("Error", "您好像没有登录豆瓣电台呀... :(");
            	//chrome.tabs.create({"url":"http://www.douban.com/accounts/login?source=radio&uid=&error=requiredemail"});
          }
        }
        // showNotification(parseStart + " " + likeNum, "");//info.selection);
        parseHtml(tab, info.selection);
      });
    }

    function parseHtml(tab, s) { // it's callback of background parser script
      var div = document.createElement('table');
      var pageMusics = new Array();
      div.innerHTML = s;
      
      var tr = div.getElementsByTagName('tr');
    
      if (tr) {
        for (var i = 0; i < tr.length; ++i) {
          var td = tr[i].getElementsByTagName('td');
          var m = new Array();
          m[0] = td[0].innerText;
          m[1] = td[1].getElementsByTagName('a')[0].href;
          m[2] = td[1].getElementsByTagName('a')[0].innerText;
          m[3] = td[1].getElementsByTagName('span')[0].innerText;
          m[4] = td[2].getElementsByTagName('a')[0].id;
          pageMusics[i] = m;
        }
      }
      
      addMore(parseStart, pageMusics);

      if (nextStartNum >= 0) {
        chrome.tabs.remove(tab.id, function(){
          chrome.tabs.create({"url":"http://douban.fm/mine?start=" + nextStartNum +"&type=liked"});
        });
      } else {
        resetDate(false);
        chrome.tabs.remove(tab.id, function(){
        	//if (likeNum != 0) {
          	chrome.tabs.create({"url":"options.html"});
          //}
        });
      }
    }

    chrome.browserAction.onClicked.addListener(startParse);
    chrome.extension.onConnect.addListener(messageListener);
    chrome.tabs.onCreated.addListener(pageLoaded);
  </script>
</html>